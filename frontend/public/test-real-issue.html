<!DOCTYPE html>
<html>
<head>
    <title>🔍 Test du Vrai Problème</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .box { border: 2px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; }
        .success { border-color: #4CAF50; background: #f0f8f0; }
        .error { border-color: #f44336; background: #fdf2f2; }
        .warning { border-color: #ff9800; background: #fff3e0; }
        .btn { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 8px; }
        .btn:hover { background: #45a049; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🔍 Diagnostic du Vrai Problème</h1>
    
    <div class="box success">
        <h2>✅ Certificat SSL Valide Confirmé</h2>
        <p><strong>Votre certificat est VALIDE !</strong></p>
        <ul>
            <li>✅ Émis par: <strong>Sectigo Limited</strong> (autorité reconnue)</li>
            <li>✅ Pour: <strong>*.investeclaire.fr</strong></li>
            <li>✅ Valide jusqu'au: <strong>11 juin 2026</strong></li>
        </ul>
        <p>Ce n'est <strong>PAS</strong> un certificat auto-signé !</p>
    </div>

    <div class="box warning">
        <h2>🤔 Alors, quel est le problème ?</h2>
        <p>Si le certificat est valide, le problème vient probablement de :</p>
        <ul>
            <li>🔧 Configuration CORS côté serveur</li>
            <li>🌐 Problème de réseau</li>
            <li>🚫 Pare-feu bloquant les requêtes</li>
            <li>📱 Configuration du navigateur</li>
        </ul>
    </div>

    <div class="box">
        <h2>🧪 Tests Détaillés</h2>
        <button class="btn" onclick="runDetailedTests()">🔍 Lancer les Tests</button>
        <div id="results"></div>
    </div>

    <script>
        async function runDetailedTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>🔄 Tests en cours...</h3>';
            
            let report = '';
            
            // Test 1: Connectivité de base
            report += '<h3>📡 Test 1: Connectivité de Base</h3>';
            try {
                const response = await fetch('https://api.investeclaire.fr/health', {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                report += `<pre style="color: green;">✅ Health Check réussi
Status: ${response.status}
Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}</pre>`;
                
                const data = await response.json();
                report += `<pre>Réponse: ${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                report += `<pre style="color: red;">❌ Health Check échoué
Erreur: ${error.name}
Message: ${error.message}
Stack: ${error.stack}</pre>`;
            }
            
            // Test 2: Test OPTIONS (preflight CORS)
            report += '<h3>🌐 Test 2: Préflight CORS (OPTIONS)</h3>';
            try {
                const response = await fetch('https://api.investeclaire.fr/api/v1/auth/register', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                report += `<pre style="color: green;">✅ OPTIONS réussi
Status: ${response.status}
CORS Headers: ${JSON.stringify(Object.fromEntries([...response.headers.entries()].filter(([k]) => k.includes('access-control'))), null, 2)}</pre>`;
            } catch (error) {
                report += `<pre style="color: red;">❌ OPTIONS échoué
Erreur: ${error.name}
Message: ${error.message}</pre>`;
            }
            
            // Test 3: Test POST register
            report += '<h3>📝 Test 3: POST Register</h3>';
            try {
                const testEmail = `test-diagnostic-${Date.now()}@example.com`;
                const response = await fetch('https://api.investeclaire.fr/api/v1/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        email: testEmail,
                        password: 'test123',
                        full_name: 'Test Diagnostic'
                    })
                });
                
                report += `<pre style="color: green;">✅ POST Register Status: ${response.status}
Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}</pre>`;
                
                if (response.ok) {
                    const data = await response.json();
                    report += `<pre style="color: green;">✅ Inscription réussie !
Utilisateur créé: ${JSON.stringify(data, null, 2)}</pre>`;
                    
                    report += '<div style="background: #d4edda; border: 2px solid #155724; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0;"><h3>🎉 PROBLÈME RÉSOLU !</h3><p>La communication fonctionne parfaitement ! Le problème était temporaire.</p><button onclick="window.location.href=\'/register\'" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">📝 Aller à Register</button></div>';
                } else {
                    const errorText = await response.text();
                    report += `<pre style="color: orange;">⚠️ Erreur HTTP ${response.status}
Réponse: ${errorText}</pre>`;
                }
            } catch (error) {
                report += `<pre style="color: red;">❌ POST Register échoué
Erreur: ${error.name}
Message: ${error.message}
Cause possible: ${error.cause || 'Inconnue'}</pre>`;
                
                // Analyser le type d'erreur
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    report += '<div style="background: #f8d7da; border: 2px solid #721c24; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0;"><h3>🔍 Analyse de l\'erreur</h3><p><strong>"Failed to fetch"</strong> peut indiquer :</p><ul><li>🚫 Bloquage par un pare-feu</li><li>🌐 Problème de réseau</li><li>📱 Paramètres de sécurité du navigateur</li><li>🔧 Configuration CORS incomplète</li></ul></div>';
                }
            }
            
            // Test 4: Configuration du navigateur
            report += '<h3>🌐 Test 4: Configuration Navigateur</h3>';
            report += `<pre>User Agent: ${navigator.userAgent}
URL actuelle: ${window.location.href}
Origin: ${window.location.origin}
Protocol: ${window.location.protocol}
Host: ${window.location.host}</pre>`;
            
            results.innerHTML = report;
        }

        // Auto-test
        setTimeout(runDetailedTests, 1000);
    </script>

    <div class="box success">
        <h2>📋 Actions Recommandées</h2>
        <ol>
            <li><strong>Testez cette page</strong> pour identifier le vrai problème</li>
            <li><strong>Si les tests passent</strong> → Le problème était temporaire</li>
            <li><strong>Si les tests échouent</strong> → Nous aurons les détails de l'erreur</li>
            <li><strong>Allez ensuite</strong> sur la page Register qui devrait fonctionner</li>
        </ol>
    </div>
</body>
</html>